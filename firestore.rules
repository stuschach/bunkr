rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for common validations
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // MESSAGES SECTION - UPDATED WITH IMPROVED RULES
    // Messages with support for sharded collections
    match /messages/{chatId} {
      // Helper function to check if user is a participant
      function isParticipant(chatId, userId) {
        return get(/databases/$(database)/documents/messages/$(chatId)).data.participants[userId] == true || 
               get(/databases/$(database)/documents/messages/$(chatId)).data.participantArray.hasAny([userId]);
      }
      
      // Allow reading if user is a participant
      allow read: if isSignedIn() && (
        resource.data.participants[request.auth.uid] == true ||
        resource.data.participantArray.hasAny([request.auth.uid])
      );
      
      // Allow creation with proper participant data
      allow create: if isSignedIn() && 
        request.resource.data.participants[request.auth.uid] == true &&
        request.resource.data.participantArray.hasAny([request.auth.uid]);
      
      // Allow updates to specific fields
      allow update: if isSignedIn() && 
        (resource.data.participants[request.auth.uid] == true ||
         resource.data.participantArray.hasAny([request.auth.uid])) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'lastMessage', 'updatedAt', 'title', 'isGroupChat', 'participantArray',
          'participants', 'unreadCounters', 'messageCount', 'archivedBy'
        ]);
      
      // Regular thread collection
      match /thread/{messageId} {
        allow read: if isSignedIn() && isParticipant(chatId, request.auth.uid);
          
        allow create: if isSignedIn() && 
          isParticipant(chatId, request.auth.uid) &&
          request.resource.data.senderId == request.auth.uid;
          
        allow update: if isSignedIn() && 
          isParticipant(chatId, request.auth.uid) &&
          (
            (resource.data.senderId == request.auth.uid && 
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['deleted', 'content'])) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy'])
          );
          
        allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
      }
      
      // Wildcard rule for all sharded thread collections using pattern matching
      match /{threadCollection}/{messageId} {
        allow read: if isSignedIn() && 
          isParticipant(chatId, request.auth.uid) && 
          threadCollection.matches('thread_[0-9]+');
          
        allow create: if isSignedIn() && 
          isParticipant(chatId, request.auth.uid) &&
          request.resource.data.senderId == request.auth.uid &&
          threadCollection.matches('thread_[0-9]+');
          
        allow update: if isSignedIn() && 
          isParticipant(chatId, request.auth.uid) &&
          threadCollection.matches('thread_[0-9]+') &&
          (
            (resource.data.senderId == request.auth.uid && 
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['deleted', 'content'])) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy'])
          );
          
        allow delete: if isSignedIn() && 
          resource.data.senderId == request.auth.uid && 
          threadCollection.matches('thread_[0-9]+');
      }
    }
    
    // USER FEEDS
    match /feeds/{userId}/posts/{postId} {
      allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
      
      allow create: if isSignedIn() && 
                     exists(/databases/$(database)/documents/posts/$(request.resource.data.postId)) &&
                     request.resource.data.authorId == 
                     get(/databases/$(database)/documents/posts/$(request.resource.data.postId)).data.authorId;
      
      allow update: if isSignedIn() && 
                     request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['likes', 'comments', 'likedByUser']);
      
      allow delete: if isSignedIn() && (
                     (exists(/databases/$(database)/documents/posts/$(resource.data.postId)) && 
                      get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.authorId == request.auth.uid) ||
                     isOwner(userId) ||
                     !exists(/databases/$(database)/documents/posts/$(resource.data.postId)) ||
                     (exists(/databases/$(database)/documents/posts/$(resource.data.postId)) &&
                      get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.isDeleted == true)
                    );
    }
    
    // User profiles
    match /users/{userId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() && 
                    request.auth.uid == userId && 
                    request.resource.data.uid == userId;
      
      allow update: if isSignedIn() && (
        isOwner(userId) || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'unreadNotifications', 'notificationPreferences', 'followerCount', 
          'followingCount', 'displayNameLower', 'fcmTokens'
        ])
      );
      
      allow delete: if isAdmin();
      
      // User's notification settings
      match /settings/notifications {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if isSignedIn() && isOwner(userId);
      }
      
      // User's notification metrics
      match /metrics/notifications {
        allow read: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && (
          isOwner(userId) || 
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['totalCount', 'typeCount', 'lastUpdated'])
        );
      }
      
      // User's rounds/scorecards
      match /rounds/{roundId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // User's saved courses
      match /favoriteCourses/{courseId} {
        allow read, write: if isOwner(userId);
      }
      
      // UPDATED: User's connections (followers/following) with proper ID format handling
      match /connections/{connectionId} {
        allow read: if isSignedIn();
        
        allow create: if isSignedIn() && (
          // User can create their own following connections 
          (isOwner(userId) && 
           connectionId.matches('following_.*') && 
           request.resource.data.type == 'following' &&
           request.resource.data.userId == connectionId.split('_')[1]) ||
          
          // User can create follower connections in another user's document
          (!isOwner(userId) && 
           connectionId == ('follower_' + request.auth.uid) &&
           request.resource.data.userId == request.auth.uid &&
           request.resource.data.type == 'follower')
        );
        
        allow update: if isSignedIn() && (
          // Owner can update their own connections
          isOwner(userId) || 
          // User can update their follower connection in another user's document
          (connectionId == ('follower_' + request.auth.uid) &&
           request.resource.data.userId == request.auth.uid &&
           request.resource.data.type == 'follower')
        );
        
        allow delete: if isSignedIn() && (
          isOwner(userId) || 
          connectionId == ('follower_' + request.auth.uid)
        );
      }
      
      // User's tee times - UPDATED with new rules for invitations
      match /teeTimes/{recordId} {
        allow read: if isSignedIn() && isOwner(userId);
        
        allow create: if isSignedIn() && (
          // User can create their own tee time records
          isOwner(userId) ||
          
          // Creator can add records for players they invite
          (request.resource.data.teeTimeId != null &&
           exists(/databases/$(database)/documents/teeTimes/$(request.resource.data.teeTimeId)) &&
           get(/databases/$(database)/documents/teeTimes/$(request.resource.data.teeTimeId)).data.creatorId == request.auth.uid)
        );
        
        allow update: if isSignedIn() && (
          // User can update their own records
          isOwner(userId) ||
          
          // Creator can update status for players in their tee times
          (request.resource.data.teeTimeId != null &&
           exists(/databases/$(database)/documents/teeTimes/$(request.resource.data.teeTimeId)) &&
           get(/databases/$(database)/documents/teeTimes/$(request.resource.data.teeTimeId)).data.creatorId == request.auth.uid)
        );
        
        allow delete: if isSignedIn() && isOwner(userId);
      }
      
      // User's saved marketplace listings
      match /savedListings/{listingId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // User's tournaments
      match /tournaments/{tournamentId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }
    }
    
    // Follow records collection
    match /followRecords/{recordId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && recordId.matches(request.auth.uid + '_.*');
    }
    
    // Handicap records
    match /handicapRecords/{recordId} {
      allow read: if isSignedIn() && (
        recordId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow write: if isSignedIn() && (
        recordId.matches(request.auth.uid + '_.*') ||
        isAdmin()
      );
    }
    
    // Deletion Records
    match /deletedContent/{recordId} {
      allow create: if isSignedIn() && 
                     (request.resource.data.authorId == request.auth.uid || isAdmin());
      
      allow read: if isSignedIn() && 
                   (resource.data.authorId == request.auth.uid || isAdmin());
      
      allow update, delete: if isAdmin();
    }
    
    // UPDATED: Notifications with improved tee time related types
    match /notifications/{notificationId} {
      // Helper function to check if notification type is valid for tee times
      function isValidTeeTimeNotification(type, actorId, entityId) {
        return (type in ['tee-time-approved', 'tee-time-cancelled', 'tee-time-invite', 
                         'tee-time-request', 'tee-time-created',
                         'tee-time-invitation-accepted', 'tee-time-invitation-declined']) &&
               (exists(/databases/$(database)/documents/teeTimes/$(entityId))) &&
               (type == 'tee-time-request' || 
                get(/databases/$(database)/documents/teeTimes/$(entityId)).data.creatorId == actorId);
      }
      
      // Helper function to check if notification type is a valid system type
      function isValidSystemNotification(type) {
        return type == 'handicap-updated' || 
               type == 'tournament-update' || 
               type == 'friend-activity' || 
               type == 'course-review';
      }
      
      // Read: Only the recipient can read their notifications
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Create with validation
      allow create: if isSignedIn() && (
        // User can only create notifications where they are the actor
        request.resource.data.actorId == request.auth.uid &&
        
        // Validate notification type
        (isValidTeeTimeNotification(request.resource.data.type, 
                                   request.resource.data.actorId,
                                   request.resource.data.entityId) ||
         isValidSystemNotification(request.resource.data.type) ||
         
         // Allow other valid notification types
         request.resource.data.type in ['like', 'comment', 'follow', 'mention', 'round-shared'])
      );
      
      // Update: Recipient can update (mark as read)
      allow update: if isSignedIn() && 
        (resource.data.userId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']));
      
      // Delete: Recipient can delete their notifications
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Tournaments
    match /tournaments/{tournamentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isSignedIn() && (
        resource.data.creatorId == request.auth.uid || 
        resource.data.admins[request.auth.uid] == true
      );
      allow delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
      
      // Tournament participants
      match /participants/{userId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn() && (
          userId == request.auth.uid || 
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.creatorId == request.auth.uid ||
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.admins[request.auth.uid] == true
        );
        allow delete: if isSignedIn() && (
          userId == request.auth.uid || 
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.creatorId == request.auth.uid ||
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.admins[request.auth.uid] == true
        );
      }
      
      // Tournament rounds/scores
      match /rounds/{roundId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn() && (
          request.resource.data.userId == request.auth.uid || 
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.creatorId == request.auth.uid ||
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.admins[request.auth.uid] == true
        );
        allow delete: if isSignedIn() && (
          resource.data.userId == request.auth.uid || 
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.creatorId == request.auth.uid ||
          get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.admins[request.auth.uid] == true
        );
      }
    }
    
    // POSTS
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      
      allow update: if isSignedIn() && (
        (resource.data.authorId == request.auth.uid) || 
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['likes', 'comments', 'likedBy', 'content', 'updatedAt', 'courseName', 'dateTime', 'maxPlayers', 'postType', 'teeTimeId', 'status', 'visibility', 'author', 'isDeleted', 'deletedAt', 'moderationReason']))
      );
      
      allow delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || isAdmin());
      
      // Comments on posts
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && (
          resource.data.authorId == request.auth.uid ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy'])
        );
        allow delete: if isSignedIn() && (
          resource.data.authorId == request.auth.uid || 
          get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid ||
          isAdmin()
        );
      }
    }
    
    // Scorecards
    match /scorecards/{scorecardId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Comments on scorecards
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      }
      
      // Likes on scorecards
      match /likes/{userId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }
    }
    
    // Golf courses
    match /courses/{courseId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() && 
                     request.resource.data.createdBy == request.auth.uid &&
                     request.resource.data.nameTokens is list;
      
      allow update: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid || 
        isAdmin()
      );
      
      allow delete: if isAdmin();
      
      // Course reviews
      match /reviews/{reviewId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      }
      
      // Course tee boxes
      match /teeBoxes/{teeBoxId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && (
          get(/databases/$(database)/documents/courses/$(courseId)).data.createdBy == request.auth.uid ||
          isAdmin()
        );
        allow update: if isSignedIn() && (
          get(/databases/$(database)/documents/courses/$(courseId)).data.createdBy == request.auth.uid ||
          isAdmin()
        );
        allow delete: if isSignedIn() && (
          get(/databases/$(database)/documents/courses/$(courseId)).data.createdBy == request.auth.uid ||
          isAdmin()
        );
      }
      
      // Course holes data
      match /holes/{holeId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn() && (
          get(/databases/$(database)/documents/courses/$(courseId)).data.createdBy == request.auth.uid ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
    }
    
    // Groups (looking for players)
    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid || 
        resource.data.admins[request.auth.uid] == true
      );
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
      
      // Group members
      match /members/{memberId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn() && (
          resource.data.createdBy == request.auth.uid || 
          resource.data.admins[request.auth.uid] == true ||
          memberId == request.auth.uid
        );
        allow delete: if isSignedIn() && (
          resource.data.createdBy == request.auth.uid || 
          resource.data.admins[request.auth.uid] == true ||
          memberId == request.auth.uid
        );
      }
    }
    
    // UPDATED: Tee Times with comprehensive security
    match /teeTimes/{teeTimeId} {
      // Helper function to check if user is a participant in a tee time
      function isParticipant(teeTimeId, userId) {
        let teeTimeDoc = get(/databases/$(database)/documents/teeTimes/$(teeTimeId));
        return teeTimeDoc.data.creatorId == userId || 
               exists(/databases/$(database)/documents/teeTimes/$(teeTimeId)/players/$(userId));
      }
      
      // Allow read access with visibility restrictions
      allow read: if isSignedIn() && (
        // Public tee times are visible to all
        resource.data.visibility == 'public' ||
        // Creator can always see their own tee times
        resource.data.creatorId == request.auth.uid ||
        // Players can see tee times they're part of
        exists(/databases/$(database)/documents/teeTimes/$(teeTimeId)/players/$(request.auth.uid)) ||
        // Followers can see tee times with 'followers' visibility
        (resource.data.visibility == 'followers' && exists(/databases/$(database)/documents/followRecords/$(resource.data.creatorId + '_' + request.auth.uid)))
      );
      
      // Allow creation with proper validation
      allow create: if isSignedIn() && 
                     request.resource.data.creatorId == request.auth.uid &&
                     request.resource.data.maxPlayers >= 1 && 
                     request.resource.data.maxPlayers <= 8 &&
                     request.resource.data.visibility in ['public', 'private', 'followers'];
      
      // Allow updates by creator
      allow update: if isSignedIn() && (
        // Creator can update with restrictions
        (resource.data.creatorId == request.auth.uid && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['creatorId'])) ||
        
        // Cloud Functions can update specific fields 
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'currentPlayers', 'updatedAt']))
      );
      
      // Allow deletion by creator
      allow delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
      
      // TEE TIME PLAYERS SUBCOLLECTION - UPDATED
      match /players/{playerId} {
        // Helper function to check player's role
        function isInvitedPlayer(playerId) {
          return get(/databases/$(database)/documents/teeTimes/$(teeTimeId)/players/$(playerId)).data.requestType == 'invitation';
        }
        
        function isJoinRequester(playerId) {
          return get(/databases/$(database)/documents/teeTimes/$(teeTimeId)/players/$(playerId)).data.requestType == 'join_request' ||
                 !get(/databases/$(database)/documents/teeTimes/$(teeTimeId)/players/$(playerId)).data.requestType;
        }
    
        // Allow reading if user is a participant
        allow read: if isSignedIn() && isParticipant(teeTimeId, request.auth.uid);
          
        // Allow creation with proper validation
        allow create: if isSignedIn() && (
          // Creator inviting a player
          (get(/databases/$(database)/documents/teeTimes/$(teeTimeId)).data.creatorId == request.auth.uid &&
           request.resource.data.requestType == 'invitation') ||
          
          // Player requesting to join
          (playerId == request.auth.uid &&
           (request.resource.data.requestType == 'join_request' || !request.resource.data.requestType))
        );
          
        // Allow updates based on role and status
        allow update: if isSignedIn() && (
          // Creator can update any player
          get(/databases/$(database)/documents/teeTimes/$(teeTimeId)).data.creatorId == request.auth.uid ||
          
          // Player can update their own status when responding to invitation
          (playerId == request.auth.uid &&
           isInvitedPlayer(playerId) &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt'])) ||
          
          // Any player can update readBy field
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy'])
        );
          
        // Allow deletion based on role
        allow delete: if isSignedIn() && (
          // Creator can remove any player
          get(/databases/$(database)/documents/teeTimes/$(teeTimeId)).data.creatorId == request.auth.uid ||
          
          // Player can remove themselves
          playerId == request.auth.uid
        );
      }
    }
    
    // Tee time archive
    match /teeTimesArchive/{teeTimeId} {
      allow read: if isSignedIn();
      allow write: if false; // Only cloud functions should write here
    }
    
    // Tee Time Invitations
    match /tee-time-invitations/{invitationId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && (
        // Creator inviting others
        request.resource.data.inviterId == request.auth.uid &&
        exists(/databases/$(database)/documents/teeTimes/$(request.resource.data.teeTimeId)) &&
        get(/databases/$(database)/documents/teeTimes/$(request.resource.data.teeTimeId)).data.creatorId == request.auth.uid
      );
      allow update: if isSignedIn() && (
        // Creator can update invitation
        resource.data.inviterId == request.auth.uid ||
        
        // Invitee can update status
        resource.data.inviteeId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'responseDate'])
      );
      allow delete: if isSignedIn() && resource.data.inviterId == request.auth.uid;
    }
    
    // Marketplace listings
    match /marketplace/{listingId} {
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      
      allow update: if isSignedIn() && (
        resource.data.sellerId == request.auth.uid ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'saves', 'savedBy']) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) &&
         request.resource.data.status == 'sold')
      );
      
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }
    
    // System collections (admin only)
    match /system/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Admin users
    match /admins/{userId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}